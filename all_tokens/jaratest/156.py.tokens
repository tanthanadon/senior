from jaratoolbox import loadbehavior from jaratoolbox import settings from jaratoolbox import ephyscore import os import numpy as np from jaratoolbox import loadopenephys from jaratoolbox import spikesanalysis from jaratoolbox import extraplots from jaratoolbox import spikesorting_ISI as spikesorting import matplotlib . pyplot as plt import sys import importlib mouseName = str ( sys . argv [ 1 ] ) allcellsFileName = <str> + mouseName sys . path . append ( settings . ALLCELLS_PATH ) allcells = importlib . import_module ( allcellsFileName ) numRows = 13 numCols = 6 sizeClusterPlot = 1 clusNum = 12 numTetrodes = 8 sizeRasters = ( numRows - sizeClusterPlot ) / 3 sizeHists = ( numRows - sizeClusterPlot ) / 6 SAMPLING_RATE = 30000.0 outputDir = <str> soundTriggerChannel = 0 binWidth = 0.010 Frequency = 1 timeRange = [ - 0.3 , 0.7 ] minBlockSize = 20 ephysRootDir = settings . EPHYS_PATH experimenter = <str> paradigm = <str> if not os . path . exists ( outputDir ) :      os . makedirs ( outputDir )  numOfCells = len ( allcells . cellDB ) subject = <str> behavSession = <str> processedDir = os . path . join ( settings . EPHYS_PATH , mouseName + <str> ) modIFilename = os . path . join ( processedDir , <str> ) modIFile = open ( modIFilename , <str> ) modIDict = { } modSigDict = { } modDirectionScoreDict = { } behavName = <str> for line in modIFile :      splitLine = line . split ( <str> ) if ( splitLine [ 0 ] == <str> ) :          behavName = splitLine [ 1 ] [ : - 1 ]  elif ( splitLine [ 0 ] == <str> ) :          modIDict [ behavName ] = [ float ( x ) for x in splitLine [ 1 ] . split ( <str> ) [ 0 : - 1 ] ]  elif ( splitLine [ 0 ] == <str> ) :          modSigDict [ behavName ] = [ float ( x ) for x in splitLine [ 1 ] . split ( <str> ) [ 0 : - 1 ] ]  elif ( splitLine [ 0 ] == <str> ) :          modDirectionScoreDict [ behavName ] = [ float ( x ) for x in splitLine [ 1 ] . split ( <str> ) [ 0 : - 1 ] ]   modIFile . close ( ) bdata = None eventOnsetTimes = None spikeTimesFromEventOnset = None indexLimitsEachTrial = None spikeTimesFromMovementOnset = None indexLimitsEachMovementTrial = None titleText = <str> badSessionList = [ ] def main ( ) :      global behavSession global subject global tetrode global cluster global bdata global eventOnsetTimes global spikeTimesFromEventOnset global indexLimitsEachTrial global spikeTimesFromMovementOnset global indexLimitsEachMovementTrial global titleText print <str> for cellID in range ( 0 , numOfCells ) :          oneCell = allcells . cellDB [ cellID ] try :              if ( behavSession != oneCell . behavSession ) :                  subject = oneCell . animalName behavSession = oneCell . behavSession ephysSession = oneCell . ephysSession ephysRoot = os . path . join ( ephysRootDir , subject ) print behavSession behaviorFilename = loadbehavior . path_to_behavior_data ( subject , experimenter , paradigm , behavSession ) bdata = loadbehavior . FlexCategBehaviorData ( behaviorFilename ) bdata . find_trials_each_block ( ) numberOfTrials = len ( bdata [ <str> ] ) ephysDir = os . path . join ( ephysRoot , ephysSession ) eventFilename = os . path . join ( ephysDir , <str> ) events = loadopenephys . Events ( eventFilename ) eventTimes = np . array ( events . timestamps ) / SAMPLING_RATE soundOnsetEvents = ( events . eventID == 1 ) & ( events . eventChannel == soundTriggerChannel ) eventOnsetTimes = eventTimes [ soundOnsetEvents ] centerOutTimes = bdata [ <str> ] soundStartTimes = bdata [ <str> ] timeDiff = centerOutTimes - soundStartTimes if ( len ( eventOnsetTimes ) < len ( timeDiff ) ) :                      timeDiff = timeDiff [ : - 1 ]  eventOnsetTimesCenter = eventOnsetTimes + timeDiff  tetrode = oneCell . tetrode cluster = oneCell . cluster spkData = ephyscore . CellData ( oneCell ) spkTimeStamps = spkData . spikes . timestamps ( spikeTimesFromEventOnset , trialIndexForEachSpike , indexLimitsEachTrial ) = spikesanalysis . eventlocked_spiketimes ( spkTimeStamps , eventOnsetTimes , timeRange ) ( spikeTimesFromMovementOnset , movementTrialIndexForEachSpike , indexLimitsEachMovementTrial ) = spikesanalysis . eventlocked_spiketimes ( spkTimeStamps , eventOnsetTimesCenter , timeRange ) plt . clf ( ) if ( len ( spkTimeStamps ) > 0 ) :                  ax1 = plt . subplot2grid ( ( numRows , numCols ) , ( ( numRows - sizeClusterPlot ) , 0 ) , colspan = ( numCols / 3 ) ) spikesorting . plot_isi_loghist ( spkData . spikes . timestamps ) ax3 = plt . subplot2grid ( ( numRows , numCols ) , ( ( numRows - sizeClusterPlot ) , ( numCols / 3 ) * 2 ) , colspan = ( numCols / 3 ) ) spikesorting . plot_events_in_time ( spkTimeStamps ) samples = spkData . spikes . samples . astype ( float ) - 2 ** 15 samples = ( 1000.0 / spkData . spikes . gain [ 0 , 0 ] ) * samples ax2 = plt . subplot2grid ( ( numRows , numCols ) , ( ( numRows - sizeClusterPlot ) , ( numCols / 3 ) ) , colspan = ( numCols / 3 ) ) spikesorting . plot_waveforms ( samples )  ax4 = plt . subplot2grid ( ( numRows , numCols ) , ( 0 , 0 ) , colspan = ( numCols ) , rowspan = 2 * sizeRasters ) plt . setp ( ax4 . get_xticklabels ( ) , visible = False ) raster_sound_block_switching ( ) ax5 = plt . subplot2grid ( ( numRows , numCols ) , ( 2 * sizeRasters , 0 ) , colspan = ( numCols ) , rowspan = sizeHists , sharex = ax4 ) hist_sound_block_switching ( ) modulation_index_switching ( ) plt . suptitle ( titleText ) tetrodeClusterName = <str> + str ( oneCell . tetrode ) + <str> + str ( oneCell . cluster ) plt . gcf ( ) . set_size_inches ( ( 8.5 , 11 ) ) figformat = <str> filename = <str> % ( subject , behavSession , tetrodeClusterName , figformat ) fulloutputDir = outputDir + subject + <str> fullFileName = os . path . join ( fulloutputDir , filename ) directory = os . path . dirname ( fulloutputDir ) if not os . path . exists ( directory ) :                  os . makedirs ( directory )  plt . gcf ( ) . savefig ( fullFileName , format = figformat )  except :              if ( oneCell . behavSession not in badSessionList ) :                  badSessionList . append ( oneCell . behavSession )    print <str> for badSes in badSessionList :          print badSes   def raster_sound_switching ( ) :      rightward = bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] leftward = bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] invalid = bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] correct = bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] correctRightward = rightward & correct correctLeftward = leftward & correct possibleFreq = np . unique ( bdata [ <str> ] ) Freq = possibleFreq [ Frequency ] oneFreq = bdata [ <str> ] == Freq trialsToUseRight = rightward & oneFreq trialsToUseLeft = leftward & oneFreq trialsEachCond = np . c_ [ trialsToUseLeft , trialsToUseRight ] ; colorEachCond = [ <str> , <str> ] extraplots . raster_plot ( spikeTimesFromEventOnset , indexLimitsEachTrial , timeRange , trialsEachCond = trialsEachCond , colorEachCond = colorEachCond , fillWidth = None , labels = None ) plt . ylabel ( <str> ) plt . title ( <str> + str ( Freq ) )  def hist_sound_switching ( ) :      rightward = bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] leftward = bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] invalid = bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] correct = bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] correctRightward = rightward & correct correctLeftward = leftward & correct possibleFreq = np . unique ( bdata [ <str> ] ) Freq = possibleFreq [ Frequency ] oneFreq = bdata [ <str> ] == Freq trialsToUseRight = rightward & oneFreq trialsToUseLeft = leftward & oneFreq trialsEachCond = np . c_ [ trialsToUseLeft , trialsToUseRight ] ; colorEachCond = [ <str> , <str> ] timeVec = np . arange ( timeRange [ 0 ] , timeRange [ - 1 ] , binWidth ) spikeCountMat = spikesanalysis . spiketimes_to_spikecounts ( spikeTimesFromEventOnset , indexLimitsEachTrial , timeVec ) smoothWinSize = 3 extraplots . plot_psth ( spikeCountMat / binWidth , smoothWinSize , timeVec , trialsEachCond = trialsEachCond , colorEachCond = colorEachCond , linestyle = None , linewidth = 2 , downsamplefactor = 1 ) plt . xlabel ( <str> ) plt . ylabel ( <str> )  def raster_movement_switching ( ) :      rightward = bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] leftward = bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] invalid = bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] correct = bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] correctRightward = rightward & correct correctLeftward = leftward & correct possibleFreq = np . unique ( bdata [ <str> ] ) Freq = possibleFreq [ Frequency ] oneFreq = bdata [ <str> ] == Freq trialsToUseRight = rightward & oneFreq trialsToUseLeft = leftward & oneFreq trialsEachCond = np . c_ [ trialsToUseLeft , trialsToUseRight ] ; colorEachCond = [ <str> , <str> ] extraplots . raster_plot ( spikeTimesFromMovementOnset , indexLimitsEachMovementTrial , timeRange , trialsEachCond = trialsEachCond , colorEachCond = colorEachCond , fillWidth = None , labels = None ) plt . ylabel ( <str> ) plt . title ( <str> )  def hist_movement_switching ( ) :      rightward = bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] leftward = bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] invalid = bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] correct = bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] correctRightward = rightward & correct correctLeftward = leftward & correct possibleFreq = np . unique ( bdata [ <str> ] ) Freq = possibleFreq [ Frequency ] oneFreq = bdata [ <str> ] == Freq trialsToUseRight = rightward & oneFreq trialsToUseLeft = leftward & oneFreq trialsEachCond = np . c_ [ trialsToUseLeft , trialsToUseRight ] ; colorEachCond = [ <str> , <str> ] timeVec = np . arange ( timeRange [ 0 ] , timeRange [ - 1 ] , binWidth ) spikeCountMat = spikesanalysis . spiketimes_to_spikecounts ( spikeTimesFromMovementOnset , indexLimitsEachMovementTrial , timeVec ) smoothWinSize = 3 extraplots . plot_psth ( spikeCountMat / binWidth , smoothWinSize , timeVec , trialsEachCond = trialsEachCond , colorEachCond = colorEachCond , linestyle = None , linewidth = 2 , downsamplefactor = 1 ) plt . xlabel ( <str> ) plt . ylabel ( <str> )  def raster_sound_allFreq_switching ( ) :      rightward = bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] leftward = bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] invalid = bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] correct = bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] correctRightward = rightward & correct correctLeftward = leftward & correct possibleFreq = np . unique ( bdata [ <str> ] ) Freq = possibleFreq [ Frequency ] oneFreq = bdata [ <str> ] == Freq trialsToUseRight = rightward & oneFreq trialsToUseLeft = leftward & oneFreq lowFreq = ( ( bdata [ <str> ] == possibleFreq [ 0 ] ) & correct ) highFreq = ( ( bdata [ <str> ] == possibleFreq [ 2 ] ) & correct ) trialsEachCond = np . c_ [ highFreq , trialsToUseLeft , trialsToUseRight , lowFreq ] ; colorEachCond = [ <str> , <str> , <str> , <str> ] extraplots . raster_plot ( spikeTimesFromEventOnset , indexLimitsEachTrial , timeRange , trialsEachCond = trialsEachCond , colorEachCond = colorEachCond , fillWidth = None , labels = None ) plt . ylabel ( <str> ) plt . title ( <str> )  def hist_sound_allFreq_switching ( ) :      rightward = bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] leftward = bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] invalid = bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] correct = bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] correctRightward = rightward & correct correctLeftward = leftward & correct possibleFreq = np . unique ( bdata [ <str> ] ) Freq = possibleFreq [ Frequency ] oneFreq = bdata [ <str> ] == Freq trialsToUseRight = rightward & oneFreq trialsToUseLeft = leftward & oneFreq lowFreq = ( ( bdata [ <str> ] == possibleFreq [ 0 ] ) & correct ) highFreq = ( ( bdata [ <str> ] == possibleFreq [ 2 ] ) & correct ) trialsEachCond = np . c_ [ highFreq , trialsToUseLeft , trialsToUseRight , lowFreq ] ; colorEachCond = [ <str> , <str> , <str> , <str> ] timeVec = np . arange ( timeRange [ 0 ] , timeRange [ - 1 ] , binWidth ) spikeCountMat = spikesanalysis . spiketimes_to_spikecounts ( spikeTimesFromEventOnset , indexLimitsEachTrial , timeVec ) smoothWinSize = 3 extraplots . plot_psth ( spikeCountMat / binWidth , smoothWinSize , timeVec , trialsEachCond = trialsEachCond , colorEachCond = colorEachCond , linestyle = None , linewidth = 2 , downsamplefactor = 1 ) plt . xlabel ( <str> ) plt . ylabel ( <str> )  def raster_movement_block_switching ( ) :      correct = bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] possibleFreq = np . unique ( bdata [ <str> ] ) Freq = possibleFreq [ Frequency ] oneFreq = bdata [ <str> ] == Freq correctOneFreq = oneFreq & correct trialsEachBlock = bdata . blocks [ <str> ] correctTrialsEachBlock = trialsEachBlock & correctOneFreq [ : , np . newaxis ] correctBlockSizes = sum ( correctTrialsEachBlock ) if ( correctBlockSizes [ - 1 ] < minBlockSize ) :          blockSizes = sum ( trialsEachBlock ) numBlocks = len ( trialsEachBlock [ 0 ] ) sumBlocks = sum ( blockSizes ) newTrialsLastBlock = np . zeros ( ( blockSizes [ - 1 ] , numBlocks ) , dtype = np . bool ) correctTrialsEachBlock [ ( sumBlocks - blockSizes [ - 1 ] ) : ] = newTrialsLastBlock  trialsEachCond = correctTrialsEachBlock ; if bdata [ <str> ] [ 0 ] == bdata . labels [ <str> ] [ <str> ] :          colorEachBlock = 4 * [ <str> , <str> ]  else :          colorEachBlock = 4 * [ <str> , <str> ]  extraplots . raster_plot ( spikeTimesFromMovementOnset , indexLimitsEachMovementTrial , timeRange , trialsEachCond = trialsEachCond , colorEachCond = colorEachBlock , fillWidth = None , labels = None ) plt . ylabel ( <str> ) plt . title ( <str> )  def hist_movement_block_switching ( ) :      correct = bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] possibleFreq = np . unique ( bdata [ <str> ] ) Freq = possibleFreq [ Frequency ] oneFreq = bdata [ <str> ] == Freq correctOneFreq = oneFreq & correct trialsEachBlock = bdata . blocks [ <str> ] correctTrialsEachBlock = trialsEachBlock & correctOneFreq [ : , np . newaxis ] correctBlockSizes = sum ( correctTrialsEachBlock ) if ( correctBlockSizes [ - 1 ] < minBlockSize ) :          blockSizes = sum ( trialsEachBlock ) numBlocks = len ( trialsEachBlock [ 0 ] ) sumBlocks = sum ( blockSizes ) newTrialsLastBlock = np . zeros ( ( blockSizes [ - 1 ] , numBlocks ) , dtype = np . bool ) correctTrialsEachBlock [ ( sumBlocks - blockSizes [ - 1 ] ) : ] = newTrialsLastBlock  trialsEachCond = correctTrialsEachBlock ; if bdata [ <str> ] [ 0 ] == bdata . labels [ <str> ] [ <str> ] :          colorEachBlock = 4 * [ <str> , <str> ]  else :          colorEachBlock = 4 * [ <str> , <str> ]  timeVec = np . arange ( timeRange [ 0 ] , timeRange [ - 1 ] , binWidth ) spikeCountMat = spikesanalysis . spiketimes_to_spikecounts ( spikeTimesFromMovementOnset , indexLimitsEachMovementTrial , timeVec ) smoothWinSize = 3 extraplots . plot_psth ( spikeCountMat / binWidth , smoothWinSize , timeVec , trialsEachCond = trialsEachCond , colorEachCond = colorEachBlock , linestyle = None , linewidth = 2 , downsamplefactor = 1 ) plt . xlabel ( <str> ) plt . ylabel ( <str> )  def raster_sound_block_switching ( ) :      correct = bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] possibleFreq = np . unique ( bdata [ <str> ] ) Freq = possibleFreq [ Frequency ] oneFreq = bdata [ <str> ] == Freq correctOneFreq = oneFreq & correct trialsEachBlock = bdata . blocks [ <str> ] correctTrialsEachBlock = trialsEachBlock & correctOneFreq [ : , np . newaxis ] correctBlockSizes = sum ( correctTrialsEachBlock ) if ( correctBlockSizes [ - 1 ] < minBlockSize ) :          blockSizes = sum ( trialsEachBlock ) numBlocks = len ( trialsEachBlock [ 0 ] ) sumBlocks = sum ( blockSizes ) newTrialsLastBlock = np . zeros ( ( blockSizes [ - 1 ] , numBlocks ) , dtype = np . bool ) correctTrialsEachBlock [ ( sumBlocks - blockSizes [ - 1 ] ) : ] = newTrialsLastBlock  trialsEachCond = correctTrialsEachBlock ; if bdata [ <str> ] [ 0 ] == bdata . labels [ <str> ] [ <str> ] :          colorEachBlock = 4 * [ <str> , <str> ]  else :          colorEachBlock = 4 * [ <str> , <str> ]  extraplots . raster_plot ( spikeTimesFromEventOnset , indexLimitsEachTrial , timeRange , trialsEachCond = trialsEachCond , colorEachCond = colorEachBlock , fillWidth = None , labels = None ) plt . ylabel ( <str> ) plt . title ( <str> )  def hist_sound_block_switching ( ) :      correct = bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] possibleFreq = np . unique ( bdata [ <str> ] ) Freq = possibleFreq [ Frequency ] oneFreq = bdata [ <str> ] == Freq correctOneFreq = oneFreq & correct trialsEachBlock = bdata . blocks [ <str> ] correctTrialsEachBlock = trialsEachBlock & correctOneFreq [ : , np . newaxis ] correctBlockSizes = sum ( correctTrialsEachBlock ) if ( correctBlockSizes [ - 1 ] < minBlockSize ) :          blockSizes = sum ( trialsEachBlock ) numBlocks = len ( trialsEachBlock [ 0 ] ) sumBlocks = sum ( blockSizes ) newTrialsLastBlock = np . zeros ( ( blockSizes [ - 1 ] , numBlocks ) , dtype = np . bool ) correctTrialsEachBlock [ ( sumBlocks - blockSizes [ - 1 ] ) : ] = newTrialsLastBlock  trialsEachCond = correctTrialsEachBlock ; if bdata [ <str> ] [ 0 ] == bdata . labels [ <str> ] [ <str> ] :          colorEachBlock = 4 * [ <str> , <str> ]  else :          colorEachBlock = 4 * [ <str> , <str> ]  timeVec = np . arange ( timeRange [ 0 ] , timeRange [ - 1 ] , binWidth ) spikeCountMat = spikesanalysis . spiketimes_to_spikecounts ( spikeTimesFromEventOnset , indexLimitsEachTrial , timeVec ) smoothWinSize = 3 extraplots . plot_psth ( spikeCountMat / binWidth , smoothWinSize , timeVec , trialsEachCond = trialsEachCond , colorEachCond = colorEachBlock , linestyle = None , linewidth = 2 , downsamplefactor = 1 ) plt . xlabel ( <str> ) plt . ylabel ( <str> )  def modulation_index_switching ( ) :      global titleText global modIDict global modSigDict global modDirectionScoreDict clusterNumber = ( tetrode - 1 ) * clusNum + ( cluster - 1 ) titleText = <str> + str ( round ( modIDict [ behavSession ] [ clusterNumber ] , 3 ) ) + <str> + str ( round ( modSigDict [ behavSession ] [ clusterNumber ] , 3 ) ) + <str> + str ( modDirectionScoreDict [ behavSession ] [ clusterNumber ] )  main ( )  