from jaratoolbox import celldatabase_quality_tuning as celldatabase from jaratoolbox import loadbehavior from jaratoolbox import settings from jaratoolbox import ephyscore import os import numpy as np from jaratoolbox import behavioranalysis from jaratoolbox import loadopenephys from jaratoolbox import spikesanalysis from jaratoolbox import extraplots import matplotlib . pyplot as plt from jaratoolbox import spikesorting_ISI as spikesorting from pylab import argsort , plot , axvline , cumsum , axhline , mean , ylabel , title , xlabel import sys import importlib mouseName = str ( sys . argv [ 1 ] ) allcellsFileName = <str> + mouseName + <str> sys . path . append ( settings . ALLCELLS_PATH ) allcells = importlib . import_module ( allcellsFileName ) numRows = 14 numCols = 6 sizeClusterPlot = 1 sizeRasters = ( numRows - sizeClusterPlot ) / 3 sizeHists = ( numRows - sizeClusterPlot ) / 6 SAMPLING_RATE = 30000.0 clusNum = 12 numTetrodes = 8 outputDir = <str> soundTriggerChannel = 0 binWidth = 0.010 timeRange = [ - 0.3 , 0.7 ] tuning_timeRange = [ - 0.2 , 0.5 ] ephysRootDir = settings . EPHYS_PATH experimenter = <str> paradigm = <str> behaviorDir = <str> class nestedDict ( dict ) :      def __getitem__ ( self , item ) :          try :              return super ( nestedDict , self ) . __getitem__ ( item )  except KeyError :              value = self [ item ] = type ( self ) ( ) return value    subject = allcells . cellDB [ 0 ] . animalName processedDir = os . path . join ( settings . EPHYS_PATH , subject + <str> ) modIFilename = os . path . join ( processedDir , <str> ) modIFile = open ( modIFilename , <str> ) modIDict = nestedDict ( ) modSigDict = nestedDict ( ) behavName = <str> for line in modIFile :      splitLine = line . split ( <str> ) if ( splitLine [ 0 ] == <str> ) :          behavName = splitLine [ 1 ] [ : - 1 ]  elif ( splitLine [ 0 ] == <str> ) :          frequency = splitLine [ 1 ] modIDict [ behavName ] [ frequency ] = [ float ( x ) for x in splitLine [ 2 ] . split ( <str> ) [ 0 : - 1 ] ]  elif ( splitLine [ 0 ] == <str> ) :          frequency = splitLine [ 1 ] modSigDict [ behavName ] [ frequency ] = [ float ( x ) for x in splitLine [ 2 ] . split ( <str> ) [ 0 : - 1 ] ]   modIFile . close ( ) numOfCells = len ( allcells . cellDB ) subject = <str> behavSession = <str> ephysSession = <str> tetrode = <str> cluster = <str> bdata = None eventOnsetTimes = None spikeTimesFromEventOnset = None indexLimitsEachTrial = None spikeTimesFromMovementOnset = None indexLimitsEachMovementTrial = None timeDiff = None badSessionList = [ ] print <str> def main ( ) :      global behavSession global subject global ephysSession global tetrode global cluster global bdata global eventOnsetTimes global spikeTimesFromEventOnset global indexLimitsEachTrial global spikeTimesFromMovementOnset global indexLimitsEachMovementTrial global tuningBehavior global tuningEphys print <str> for cellID in range ( 0 , numOfCells ) :              oneCell = allcells . cellDB [ cellID ] if ( behavSession != oneCell . behavSession ) :                  subject = oneCell . animalName behavSession = oneCell . behavSession ephysSession = oneCell . ephysSession ephysRoot = os . path . join ( ephysRootDir , subject ) tuningBehavior = oneCell . tuningBehavior tuningEphys = oneCell . tuningSession print behavSession behaviorFilename = loadbehavior . path_to_behavior_data ( subject = subject , paradigm = paradigm , sessionstr = behavSession ) bdata = loadbehavior . BehaviorData ( behaviorFilename ) numberOfTrials = len ( bdata [ <str> ] ) ephysDir = os . path . join ( ephysRoot , ephysSession ) eventFilename = os . path . join ( ephysDir , <str> ) events = loadopenephys . Events ( eventFilename ) eventTimes = np . array ( events . timestamps ) / SAMPLING_RATE soundOnsetEvents = ( events . eventID == 1 ) & ( events . eventChannel == soundTriggerChannel ) eventOnsetTimes = eventTimes [ soundOnsetEvents ] soundOnsetTimeBehav = bdata [ <str> ] missingTrials = behavioranalysis . find_missing_trials ( eventOnsetTimes , soundOnsetTimeBehav ) bdata . remove_trials ( missingTrials ) possibleFreq = np . unique ( bdata [ <str> ] ) numberOfFrequencies = len ( possibleFreq ) centerFrequencies = [ ( numberOfFrequencies / 2 - 1 ) , numberOfFrequencies / 2 ] centerOutTimes = bdata [ <str> ] soundStartTimes = bdata [ <str> ] timeDiff = centerOutTimes - soundStartTimes if ( len ( eventOnsetTimes ) < len ( timeDiff ) ) :                      eventOnsetTimesCenter = eventOnsetTimes + timeDiff [ : - 1 ]  elif ( len ( eventOnsetTimes ) > len ( timeDiff ) ) :                      eventOnsetTimesCenter = eventOnsetTimes [ : - 1 ] + timeDiff  else :                      eventOnsetTimesCenter = eventOnsetTimes + timeDiff   tetrode = oneCell . tetrode cluster = oneCell . cluster spkData = ephyscore . CellData ( oneCell ) spkTimeStamps = spkData . spikes . timestamps ( spikeTimesFromEventOnset , trialIndexForEachSpike , indexLimitsEachTrial ) = spikesanalysis . eventlocked_spiketimes ( spkTimeStamps , eventOnsetTimes , timeRange ) ( spikeTimesFromMovementOnset , movementTrialIndexForEachSpike , indexLimitsEachMovementTrial ) = spikesanalysis . eventlocked_spiketimes ( spkTimeStamps , eventOnsetTimesCenter , timeRange ) plt . clf ( ) if ( len ( spkTimeStamps ) > 0 ) :                  ax1 = plt . subplot2grid ( ( numRows , numCols ) , ( ( numRows - sizeClusterPlot ) , 0 ) , colspan = ( numCols / 3 ) ) spikesorting . plot_isi_loghist ( spkData . spikes . timestamps ) ax3 = plt . subplot2grid ( ( numRows , numCols ) , ( ( numRows - sizeClusterPlot ) , ( numCols / 3 ) * 2 ) , colspan = ( numCols / 3 ) ) spikesorting . plot_events_in_time ( spkData . spikes . timestamps ) samples = spkData . spikes . samples . astype ( float ) - 2 ** 15 samples = ( 1000.0 / spkData . spikes . gain [ 0 , 0 ] ) * samples ax2 = plt . subplot2grid ( ( numRows , numCols ) , ( ( numRows - sizeClusterPlot ) , ( numCols / 3 ) ) , colspan = ( numCols / 3 ) ) spikesorting . plot_waveforms ( samples )  ax4 = plt . subplot2grid ( ( numRows , numCols ) , ( 0 , 0 ) , colspan = ( numCols / 2 ) , rowspan = 3 * sizeRasters ) raster_tuning ( ax4 ) axvline ( x = 0 , ymin = 0 , ymax = 1 , color = <str> ) plt . gca ( ) . set_xlim ( tuning_timeRange ) ax6 = plt . subplot2grid ( ( numRows , numCols ) , ( 0 , ( numCols / 2 ) ) , colspan = ( numCols / 2 ) , rowspan = sizeRasters ) plt . setp ( ax6 . get_xticklabels ( ) , visible = False ) plt . setp ( ax6 . get_yticklabels ( ) , visible = False ) raster_sound_psycurve ( centerFrequencies [ 0 ] ) plt . title ( <str> + str ( possibleFreq [ centerFrequencies [ 0 ] ] ) + <str> + str ( possibleFreq [ centerFrequencies [ 1 ] ] ) ) ax7 = plt . subplot2grid ( ( numRows , numCols ) , ( sizeRasters , ( numCols / 2 ) ) , colspan = ( numCols / 2 ) , rowspan = sizeHists , sharex = ax6 ) hist_sound_psycurve ( centerFrequencies [ 0 ] ) ax7 . yaxis . tick_right ( ) ax7 . yaxis . set_ticks_position ( <str> ) plt . setp ( ax7 . get_xticklabels ( ) , visible = False ) plt . gca ( ) . set_xlim ( timeRange ) ax10 = plt . subplot2grid ( ( numRows , numCols ) , ( ( sizeRasters + sizeHists ) , ( numCols / 2 ) ) , colspan = ( numCols / 2 ) , rowspan = sizeRasters ) plt . setp ( ax10 . get_xticklabels ( ) , visible = False ) plt . setp ( ax10 . get_yticklabels ( ) , visible = False ) raster_sound_psycurve ( centerFrequencies [ 1 ] ) ax11 = plt . subplot2grid ( ( numRows , numCols ) , ( ( 2 * sizeRasters + sizeHists ) , ( numCols / 2 ) ) , colspan = ( numCols / 2 ) , rowspan = sizeHists , sharex = ax10 ) hist_sound_psycurve ( centerFrequencies [ 1 ] ) ax11 . yaxis . tick_right ( ) ax11 . yaxis . set_ticks_position ( <str> ) plt . gca ( ) . set_xlim ( timeRange ) modulation_index_psycurve ( centerFrequencies ) plt . suptitle ( titleText ) tetrodeClusterName = <str> + str ( oneCell . tetrode ) + <str> + str ( oneCell . cluster ) plt . gcf ( ) . set_size_inches ( ( 8.5 , 11 ) ) figformat = <str> filename = <str> % ( subject , behavSession , tetrodeClusterName , figformat ) fulloutputDir = outputDir + subject + <str> fullFileName = os . path . join ( fulloutputDir , filename ) directory = os . path . dirname ( fulloutputDir ) if not os . path . exists ( directory ) :                  os . makedirs ( directory )  plt . gcf ( ) . savefig ( fullFileName , format = figformat )  print <str> for badSes in badSessionList :          print badSes   def raster_sound_psycurve ( Frequency ) :      rightward = bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] leftward = bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] invalid = bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] possibleFreq = np . unique ( bdata [ <str> ] ) Freq = possibleFreq [ Frequency ] oneFreq = bdata [ <str> ] == Freq trialsToUseRight = rightward & oneFreq trialsToUseLeft = leftward & oneFreq trialsEachCond = np . c_ [ trialsToUseLeft , trialsToUseRight ] ; colorEachCond = [ <str> , <str> ] extraplots . raster_plot ( spikeTimesFromEventOnset , indexLimitsEachTrial , timeRange , trialsEachCond = trialsEachCond , colorEachCond = colorEachCond , fillWidth = None , labels = None )  def hist_sound_psycurve ( Frequency ) :      rightward = bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] leftward = bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] invalid = bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] possibleFreq = np . unique ( bdata [ <str> ] ) Freq = possibleFreq [ Frequency ] oneFreq = bdata [ <str> ] == Freq trialsToUseRight = rightward & oneFreq trialsToUseLeft = leftward & oneFreq trialsEachCond = np . c_ [ trialsToUseLeft , trialsToUseRight ] ; colorEachCond = [ <str> , <str> ] timeVec = np . arange ( timeRange [ 0 ] , timeRange [ - 1 ] , binWidth ) spikeCountMat = spikesanalysis . spiketimes_to_spikecounts ( spikeTimesFromEventOnset , indexLimitsEachTrial , timeVec ) smoothWinSize = 3 extraplots . plot_psth ( spikeCountMat / binWidth , smoothWinSize , timeVec , trialsEachCond = trialsEachCond , colorEachCond = colorEachCond , linestyle = None , linewidth = 3 , downsamplefactor = 1 )  def raster_movement_psycurve ( Frequency ) :      rightward = bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] leftward = bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] invalid = bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] possibleFreq = np . unique ( bdata [ <str> ] ) Freq = possibleFreq [ Frequency ] oneFreq = bdata [ <str> ] == Freq trialsToUseRight = rightward & oneFreq trialsToUseLeft = leftward & oneFreq trialsEachCond = np . c_ [ trialsToUseLeft , trialsToUseRight ] ; colorEachCond = [ <str> , <str> ] extraplots . raster_plot ( spikeTimesFromMovementOnset , indexLimitsEachMovementTrial , timeRange , trialsEachCond = trialsEachCond , colorEachCond = colorEachCond , fillWidth = None , labels = None )  def hist_movement_psycurve ( Frequency ) :      rightward = bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] leftward = bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] invalid = bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] possibleFreq = np . unique ( bdata [ <str> ] ) Freq = possibleFreq [ Frequency ] oneFreq = bdata [ <str> ] == Freq trialsToUseRight = rightward & oneFreq trialsToUseLeft = leftward & oneFreq trialsEachCond = np . c_ [ trialsToUseLeft , trialsToUseRight ] ; colorEachCond = [ <str> , <str> ] timeVec = np . arange ( timeRange [ 0 ] , timeRange [ - 1 ] , binWidth ) spikeCountMat = spikesanalysis . spiketimes_to_spikecounts ( spikeTimesFromMovementOnset , indexLimitsEachMovementTrial , timeVec ) smoothWinSize = 3 extraplots . plot_psth ( spikeCountMat / binWidth , smoothWinSize , timeVec , trialsEachCond = trialsEachCond , colorEachCond = colorEachCond , linestyle = None , linewidth = 3 , downsamplefactor = 1 )  def modulation_index_psycurve ( centerFrequencies ) :      global titleText global modIDict global modSigDict global cluster global tetrode clusterNumber = ( tetrode - 1 ) * clusNum + ( cluster - 1 ) possibleFreq = np . unique ( bdata [ <str> ] ) Freq1 = str ( possibleFreq [ centerFrequencies [ 0 ] ] ) firstCenterMI = str ( round ( modIDict [ behavSession ] [ Freq1 ] [ clusterNumber ] , 3 ) ) firstCenterMSig = str ( round ( modSigDict [ behavSession ] [ Freq1 ] [ clusterNumber ] , 3 ) ) Freq2 = str ( possibleFreq [ centerFrequencies [ 1 ] ] ) secondCenterMI = str ( round ( modIDict [ behavSession ] [ Freq2 ] [ clusterNumber ] , 3 ) ) secondCenterMSig = str ( round ( modSigDict [ behavSession ] [ Freq2 ] [ clusterNumber ] , 3 ) ) titleText = <str> + firstCenterMI + <str> + firstCenterMSig + <str> + secondCenterMI + <str> + secondCenterMSig  def raster_tuning ( ax ) :      fullbehaviorDir = behaviorDir + subject + <str> behavName = subject + <str> + tuningBehavior + <str> tuningBehavFileName = os . path . join ( fullbehaviorDir , behavName ) tuning_bdata = loadbehavior . BehaviorData ( tuningBehavFileName , readmode = <str> ) freqEachTrial = tuning_bdata [ <str> ] possibleFreq = np . unique ( freqEachTrial ) numberOfTrials = len ( freqEachTrial ) sortedTrials = [ ] numTrialsEachFreq = [ ] for indf , oneFreq in enumerate ( possibleFreq ) :          indsThisFreq = np . flatnonzero ( freqEachTrial == oneFreq ) sortedTrials = np . concatenate ( ( sortedTrials , indsThisFreq ) ) numTrialsEachFreq . append ( len ( indsThisFreq ) )  sortingInds = argsort ( sortedTrials ) tuning_ephysDir = os . path . join ( settings . EPHYS_PATH , subject , tuningEphys ) tuning_eventFilename = os . path . join ( tuning_ephysDir , <str> ) tuning_ev = loadopenephys . Events ( tuning_eventFilename ) tuning_eventTimes = np . array ( tuning_ev . timestamps ) / SAMPLING_RATE tuning_evID = np . array ( tuning_ev . eventID ) tuning_eventOnsetTimes = tuning_eventTimes [ tuning_evID == 1 ] while ( numberOfTrials < len ( tuning_eventOnsetTimes ) ) :          tuning_eventOnsetTimes = tuning_eventOnsetTimes [ : - 1 ]  thisCell = celldatabase . CellInfo ( animalName = subject , ephysSession = tuningEphys , tuningSession = <str> , tetrode = tetrode , cluster = cluster , quality = 1 , depth = 0 , tuningBehavior = <str> , behavSession = tuningBehavior ) tuning_spkData = ephyscore . CellData ( thisCell ) tuning_spkTimeStamps = tuning_spkData . spikes . timestamps ( tuning_spikeTimesFromEventOnset , tuning_trialIndexForEachSpike , tuning_indexLimitsEachTrial ) = spikesanalysis . eventlocked_spiketimes ( tuning_spkTimeStamps , tuning_eventOnsetTimes , tuning_timeRange ) tuning_sortedIndexForEachSpike = sortingInds [ tuning_trialIndexForEachSpike ] plot ( tuning_spikeTimesFromEventOnset , tuning_sortedIndexForEachSpike , <str> , ms = 3 ) numTrials = cumsum ( numTrialsEachFreq ) for indf , num in enumerate ( numTrials ) :          ax . axhline ( y = num , xmin = 0 , xmax = 1 , color = <str> , zorder = 0 )  tickPositions = numTrials - mean ( numTrialsEachFreq ) / 2 tickLabels = [ <str> % ( possibleFreq [ indf ] / 1000 ) for indf in range ( len ( possibleFreq ) ) ] ax . set_yticks ( tickPositions ) ax . set_yticklabels ( tickLabels ) ax . set_ylim ( [ - 1 , numberOfTrials ] ) ylabel ( <str> . format ( numTrials [ - 1 ] ) ) xlabel ( <str> )  main ( )  