from __future__ import division from __future__ import print_function import os import sys import cv2 import glob from builtins import range from skimage import io import numpy as np from matplotlib import pyplot as plt from jaratoolbox import extraplots import caiman as cm from caiman . motion_correction import MotionCorrect import tifffile datafile = <str> RUN_MOTION_CORRECTION = 1 SHOW_MOVIE = 0 SAVE_TIFF = 0 cv2 . setNumThreads ( 1 ) dview = None niter_rig = 1 max_shifts = ( 6 , 6 ) splits_rig = 20 strides = ( 48 , 48 ) overlaps = ( 24 , 24 ) splits_els = 20 upsample_factor_grid = 4 max_deviation_rigid = 3 moviehandle = cm . load ( datafile ) if RUN_MOTION_CORRECTION :      min_mov = cm . load ( datafile , subindices = range ( 200 ) ) . min ( ) mc = MotionCorrect ( datafile , min_mov , dview = dview , max_shifts = max_shifts , niter_rig = niter_rig , splits_rig = splits_rig , strides = strides , overlaps = overlaps , splits_els = splits_els , upsample_factor_grid = upsample_factor_grid , max_deviation_rigid = max_deviation_rigid , shifts_opencv = True , nonneg_movie = True ) mc . motion_correct_pwrigid ( save_movie = True ) m_els = cm . load ( mc . fname_tot_els ) bord_px_els = np . ceil ( np . maximum ( np . max ( np . abs ( mc . x_shifts_els ) ) , np . max ( np . abs ( mc . y_shifts_els ) ) ) ) . astype ( np . int ) fname = mc . fname_tot_els fname_new = cm . save_memmap ( fname , base_name = <str> , order = <str> , border_to_0 = bord_px_els ) moviehandle = cm . load ( datafile ) if SHOW_MOVIE :          cm . concatenate ( [ moviehandle , m_els ] , axis = 2 ) . play ( fr = 60 , gain = 3 , magnification = 3 , offset = 0 )   if SAVE_TIFF :      memmapFilename = <str> Yr , dims , T = cm . load_memmap ( memmapFilename ) images = np . reshape ( Yr . T , [ T ] + list ( dims ) , order = <str> ) tifffile . imsave ( <str> , images )    