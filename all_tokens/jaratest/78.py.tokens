from __future__ import division from __future__ import print_function import os import sys import cv2 import glob import time from builtins import range from skimage import io import numpy as np from matplotlib import pyplot as plt from jaratoolbox import extraplots import caiman as cm import tifffile datafile = <str> bord_px_els = 6 fr = 10 decay_time = 0.4 RUN_CNMF = 0 PLOT_RESULTS = 1 cv2 . setNumThreads ( 1 ) dview = None p = 1 gnb = 2 merge_thresh = 0.8 rf = 20 stride_cnmf = 8 K = 2 gSig = [ 4 , 4 ] init_method = <str> is_dendrites = False alpha_snmf = None min_SNR = 0.8 rval_thr = 0.8 cnn_thr = 0.8 fname_new = <str> Yr , dims , T = cm . load_memmap ( fname_new ) images = np . reshape ( Yr . T , [ T ] + list ( dims ) , order = <str> ) t1 = time . time ( ) cnm = cm . source_extraction . cnmf . CNMF ( n_processes = 1 , k = K , gSig = gSig , merge_thresh = merge_thresh , p = 0 , dview = dview , rf = rf , stride = stride_cnmf , memory_fact = 1 , method_init = init_method , alpha_snmf = alpha_snmf , only_init_patch = False , gnb = gnb , border_pix = bord_px_els ) cnm = cnm . fit ( images ) Cn = cm . local_correlations ( images . transpose ( 1 , 2 , 0 ) ) Cn [ np . isnan ( Cn ) ] = 0 if 0 :      plt . figure ( 1 ) plt . clf ( ) crd = cm . utils . visualization . plot_contours ( cnm . A , Cn , thr = 0.9 ) plt . title ( <str> ) plt . show ( )  idx_components , idx_components_bad , SNR_comp , r_values , cnn_preds = cm . components_evaluation . estimate_components_quality_auto ( images , cnm . A , cnm . C , cnm . b , cnm . f , cnm . YrA , fr , decay_time , gSig , dims , dview = dview , min_SNR = min_SNR , r_values_min = rval_thr , use_cnn = False , thresh_cnn_min = cnn_thr ) if PLOT_RESULTS :      plt . figure ( 2 ) plt . clf ( ) plt . subplot ( 121 ) crd_good = cm . utils . visualization . plot_contours ( cnm . A [ : , idx_components ] , Cn , thr = .8 , vmax = 0.75 ) plt . title ( <str> ) plt . subplot ( 122 ) crd_bad = cm . utils . visualization . plot_contours ( cnm . A [ : , idx_components_bad ] , Cn , thr = .8 , vmax = 0.75 ) plt . title ( <str> ) plt . show ( )  if PLOT_RESULTS :      cm . utils . visualization . view_patches_bar ( Yr , cnm . A . tocsc ( ) [ : , idx_components ] , cnm . C [ idx_components ] , cnm . b , cnm . f , dims [ 0 ] , dims [ 1 ] , YrA = cnm . YrA [ idx_components ] , img = Cn ) plt . show ( )  sys . exit ( ) A_in , C_in , b_in , f_in = cnm . A [ : , idx_components ] , cnm . C [ idx_components ] , cnm . b , cnm . f cnm2 = cm . source_extraction . cnmf . CNMF ( n_processes = 1 , k = A_in . shape [ - 1 ] , gSig = gSig , p = p , dview = dview , merge_thresh = merge_thresh , Ain = A_in , Cin = C_in , b_in = b_in , f_in = f_in , rf = None , stride = None , gnb = gnb , method_deconvolution = <str> , check_nan = True ) cnm2 = cnm2 . fit ( images ) sys . exit ( ) F_dff = cm . source_extraction . cnmf . utilities . detrend_df_f ( cnm2 . A , cnm2 . b , cnm2 . C , cnm2 . f , YrA = cnm2 . YrA , quantileMin = 8 , frames_window = 50 ) if 0 :      cnm2 . view_patches ( Yr , dims = dims , img = Cn )  denoised = cm . movie ( cnm2 . A . dot ( cnm2 . C ) + cnm2 . b . dot ( cnm2 . f ) ) . reshape ( dims + ( - 1 , ) , order = <str> ) . transpose ( [ 2 , 0 , 1 ] ) moviehandle = cm . concatenate ( [ m_els . resize ( 1 , 1 , downsample_ratio ) , denoised . resize ( 1 , 1 , downsample_ratio ) ] , axis = 2 ) if PLOT_RESULTS :      moviehandle . play ( fr = 60 , gain = 15 , magnification = 2 , offset = 0 )   