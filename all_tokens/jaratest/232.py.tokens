from jaratoolbox import loadbehavior from jaratoolbox import settings from jaratoolbox import ephyscore import os import numpy as np from jaratoolbox import loadopenephys from jaratoolbox import spikesanalysis from jaratoolbox import extraplots import matplotlib . pyplot as plt import sys import importlib mouseName = str ( sys . argv [ 1 ] ) allcellsFileName = <str> + mouseName sys . path . append ( settings . ALLCELLS_PATH ) allcells = importlib . import_module ( allcellsFileName ) SAMPLING_RATE = 30000.0 soundTriggerChannel = 0 binWidth = 0.020 Frequency = 1 countTimeRange = [ 0 , 0.1 ] clusNum = 12 numTetrodes = 8 stimulusRange = [ 0.0 , 0.1 ] timeRange = [ - 0.2 , 0.8 ] ephysRootDir = settings . EPHYS_PATH outputDir = <str> experimenter = <str> paradigm = <str> numOfCells = len ( allcells . cellDB ) subject = allcells . cellDB [ 0 ] . animalName behavSession = <str> processedDir = os . path . join ( settings . EPHYS_PATH , subject + <str> ) nameOfFile = <str> finalOutputDir = outputDir + <str> + subject + <str> class nestedDict ( dict ) :      def __getitem__ ( self , item ) :          try :              return super ( nestedDict , self ) . __getitem__ ( item )  except KeyError :              value = self [ item ] = type ( self ) ( ) return value    modIList = [ ] try :      modI_file = open ( <str> % ( finalOutputDir , nameOfFile ) , <str> ) behavName = <str> for line in modI_file :          behavLine = line . split ( <str> ) if ( behavLine [ 0 ] == <str> ) :              behavName = behavLine [ 1 ] [ : - 1 ] modIList . append ( behavName )    except :      modI_file = open ( <str> % ( finalOutputDir , nameOfFile ) , <str> )  badSessionList = [ ] behavSession = <str> modIndexArray = [ ] modIDict = nestedDict ( ) for cellID in range ( 0 , numOfCells ) :      oneCell = allcells . cellDB [ cellID ] if ( oneCell . behavSession in modIList ) :          continue  try :          if ( behavSession != oneCell . behavSession ) :              subject = oneCell . animalName behavSession = oneCell . behavSession ephysSession = oneCell . ephysSession ephysRoot = os . path . join ( ephysRootDir , subject ) print behavSession behaviorFilename = loadbehavior . path_to_behavior_data ( subject , experimenter , paradigm , behavSession ) bdata = loadbehavior . BehaviorData ( behaviorFilename ) ephysDir = os . path . join ( ephysRoot , ephysSession ) eventFilename = os . path . join ( ephysDir , <str> ) events = loadopenephys . Events ( eventFilename ) eventTimes = np . array ( events . timestamps ) / SAMPLING_RATE soundOnsetEvents = ( events . eventID == 1 ) & ( events . eventChannel == soundTriggerChannel ) eventOnsetTimes = eventTimes [ soundOnsetEvents ] rightward = bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] leftward = bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] valid = ( bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] ) | ( bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] ) correct = bdata [ <str> ] == bdata . labels [ <str> ] [ <str> ] correctRightward = rightward & correct correctLeftward = leftward & correct possibleFreq = np . unique ( bdata [ <str> ] ) numberOfFrequencies = len ( possibleFreq ) numberOfTrials = len ( bdata [ <str> ] ) targetFreqs = bdata [ <str> ] for possFreq in possibleFreq :                  modIDict [ behavSession ] [ possFreq ] = np . empty ( [ clusNum * numTetrodes ] )   spkData = ephyscore . CellData ( oneCell ) spkTimeStamps = spkData . spikes . timestamps clusterNumber = ( oneCell . tetrode - 1 ) * clusNum + ( oneCell . cluster - 1 ) for Freq in possibleFreq :              oneFreq = targetFreqs == Freq trialsToUseRight = rightward & oneFreq trialsToUseLeft = leftward & oneFreq ( spikeTimesFromEventOnset , trialIndexForEachSpike , indexLimitsEachTrial ) = spikesanalysis . eventlocked_spiketimes ( spkTimeStamps , eventOnsetTimes , timeRange ) spikeCountMat = spikesanalysis . spiketimes_to_spikecounts ( spikeTimesFromEventOnset , indexLimitsEachTrial , countTimeRange ) spikeCountEachTrial = spikeCountMat . flatten ( ) spikeAvgRight = sum ( spikeCountEachTrial [ trialsToUseRight ] ) / float ( sum ( trialsToUseRight ) ) spikeAvgLeft = sum ( spikeCountEachTrial [ trialsToUseLeft ] ) / float ( sum ( trialsToUseLeft ) ) if ( ( spikeAvgRight + spikeAvgLeft ) == 0 ) :                  modIDict [ behavSession ] [ Freq ] [ clusterNumber ] = 0.0  else :                  modIDict [ behavSession ] [ Freq ] [ clusterNumber ] = ( ( spikeAvgRight - spikeAvgLeft ) / ( spikeAvgRight + spikeAvgLeft ) )    except :          if ( oneCell . behavSession not in badSessionList ) :              badSessionList . append ( oneCell . behavSession )    bSessionList = [ ] for bSession in modIDict :      if ( bSession not in badSessionList ) :          bSessionList . append ( bSession )   bSessionList . sort ( ) for bSession in bSessionList :      modI_file . write ( <str> % bSession ) for freq in modIDict [ bSession ] :          modI_file . write ( <str> % str ( freq ) ) for modIInd in modIDict [ bSession ] [ freq ] :              modI_file . write ( <str> % modIInd )  modI_file . write ( <str> )   modI_file . close ( ) print <str> for badSes in badSessionList :      print badSes  print <str>  