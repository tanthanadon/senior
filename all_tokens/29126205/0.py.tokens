import numpy as np import glob , pickle import matplotlib . pyplot as plt import healpy as hp from astropy . io import fits Nside = 2048 Npix = 12 * Nside ** 2 def P_Plasz ( map353 , cov353 ) :      mapphi353 = np . arctan2 ( map353 [ 2 ] , map353 [ 1 ] ) Plasz_theta = np . mod ( 0.5 * np . arctan2 ( 2.0 * cov353 [ 1 , 2 ] , cov353 [ 1 , 1 ] - cov353 [ 2 , 2 ] ) , np . pi ) Plasz_sigQp2 = cov353 [ 1 , 1 ] * ( np . cos ( Plasz_theta ) ) ** 2.0 + cov353 [ 2 , 2 ] * ( np . sin ( Plasz_theta ) ) ** 2.0 + cov353 [ 1 , 2 ] * np . sin ( 2.0 * Plasz_theta ) Plasz_sigUp2 = cov353 [ 1 , 1 ] * ( np . sin ( Plasz_theta ) ) ** 2.0 + cov353 [ 2 , 2 ] * ( np . cos ( Plasz_theta ) ) ** 2.0 - cov353 [ 1 , 2 ] * np . sin ( 2.0 * Plasz_theta ) mapvarbias353 = np . sqrt ( Plasz_sigUp2 * ( np . cos ( mapphi353 - Plasz_theta ) ) ** 2.0 + Plasz_sigQp2 * ( np . sin ( mapphi353 - Plasz_theta ) ) ** 2.0 ) mapPnaive353 = np . sqrt ( map353 [ 1 ] ** 2.0 + map353 [ 2 ] ** 2.0 ) mapP353 = mapPnaive353 - mapvarbias353 ** 2.0 * ( 1.0 - np . exp ( - mapPnaive353 ** 2.0 / mapvarbias353 ** 2.0 ) ) / ( 2.0 * mapPnaive353 ) mapsigP353 = np . sqrt ( Plasz_sigQp2 * ( np . cos ( mapphi353 - Plasz_theta ) ) ** 2.0 + Plasz_sigUp2 * ( np . sin ( mapphi353 - Plasz_theta ) ) ** 2.0 ) return mapPnaive353 , mapP353 , mapsigP353  planckroot = <str> planckmapfn = planckroot + <str> map353Gal = np . zeros ( ( 3 , Npix ) ) cov353Gal = np . zeros ( ( 3 , 3 , Npix ) ) planck353full = fits . open ( planckmapfn ) sigTTsq = planck353full [ 1 ] . data [ <str> ] sigTQsq = planck353full [ 1 ] . data [ <str> ] sigTUsq = planck353full [ 1 ] . data [ <str> ] sigQQsq = planck353full [ 1 ] . data [ <str> ] sigUUsq = planck353full [ 1 ] . data [ <str> ] sigQUsq = planck353full [ 1 ] . data [ <str> ] cov353Gal [ 0 , 0 , : ] = sigTTsq cov353Gal [ 1 , 1 , : ] = sigQQsq cov353Gal [ 1 , 2 , : ] = sigQUsq cov353Gal [ 2 , 2 , : ] = sigUUsq map353Gal [ 0 , : ] = planck353full [ 1 ] . data [ <str> ] map353Gal [ 1 , : ] = planck353full [ 1 ] . data [ <str> ] map353Gal [ 2 , : ] = planck353full [ 1 ] . data [ <str> ] mapPnaive353Gal , mapP353Gal , mapsigP353Gal = P_Plasz ( map353Gal , cov353Gal ) hp . fitsfunc . write_map ( planckroot + <str> , mapP353Gal , coord = <str> ) hp . fitsfunc . write_map ( planckroot + <str> , mapsigP353Gal , coord = <str> ) plt . clf ( ) hp . mollview ( mapP353Gal , unit = <str> , title = <str> , coord = <str> , min = 0.0 , max = 1.0e-3 ) plt . savefig ( <str> ) plt . clf ( ) hp . mollview ( mapPnaive353Gal , unit = <str> , title = <str> , coord = <str> , min = 0.0 , max = 1.0e-3 ) plt . savefig ( <str> ) plt . clf ( ) hp . mollview ( mapPnaive353Gal - mapP353Gal , unit = <str> , title = <str> , coord = <str> , min = 0.0 , max = 1.0e-3 ) plt . savefig ( <str> ) plt . clf ( ) hp . mollview ( mapP353Gal / mapsigP353Gal , unit = <str> , title = <str> , coord = <str> , min = 0.0 , max = 5.0 ) plt . savefig ( <str> )  