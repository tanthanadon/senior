import numpy as np import ehtim as eh import ehtim . scattering as so npix = 200 fov = 500 * eh . RADPERUAS total_flux = 3.4 im = eh . image . Image ( np . zeros ( ( npix , npix ) ) , fov / npix , eh . RA_DEFAULT , eh . DEC_DEFAULT , rf = 86e9 ) im = im . add_crescent ( total_flux , 105 * eh . RADPERUAS , 95 * eh . RADPERUAS , 0 , 0 ) im = im . blur_circ ( 10 * eh . RADPERUAS ) im . display ( ) ep = so . MakeEpsilonScreen ( im . xdim , im . ydim , rngseed = 34 ) sm = so . ScatteringModel ( ) scatt = sm . Scatter ( im , ep , DisplayImage = True ) eht = eh . array . load_txt ( <str> ) tint_sec = 60 tadv_sec = 600 tstart_hr = 0 tstop_hr = 24 bw_hz = 0.5e9 obs = scatt . observe ( eht , tint_sec , tadv_sec , tstart_hr , tstop_hr , bw_hz , sgrscat = False , ampcal = True , phasecal = True ) npix = 55 prior_fwhm = 300 * eh . RADPERUAS gaussprior = eh . image . Image ( np . zeros ( ( npix , npix ) ) , fov / npix , im . ra , im . dec , rf = im . rf , source = im . source , mjd = im . mjd ) gaussprior = gaussprior . add_gauss ( total_flux , ( prior_fwhm , prior_fwhm , 0 , 0 , 0 ) ) imgr = eh . imager . Imager ( obs , gaussprior , prior_im = gaussprior , maxit = 200 , flux = total_flux , clipfloor = - 1. ) imgr . make_image_I ( ) imgr . out_last ( ) . display ( ) imgr_deblur = eh . imager . Imager ( sm . Deblur_obs ( obs ) , gaussprior , prior_im = gaussprior , maxit = 200 , flux = total_flux , clipfloor = - 1. ) imgr_deblur . make_image_I ( ) imgr_deblur . out_last ( ) . display ( ) imgr_so = eh . imager . Imager ( obs , gaussprior , prior_im = gaussprior , maxit = 200 , flux = total_flux , clipfloor = - 1. ) imgr_so . make_image_I_stochastic_optics ( ) imgr_so . out_last ( ) . display ( ) imgr_so . out_scattered_last ( ) . display ( ) imgr_so . scattering_model . Scatter ( imgr_so . out_last ( ) , Epsilon_Screen = so . MakeEpsilonScreenFromList ( imgr_so . out_epsilon_last ( ) , npix ) , ea_ker = imgr_so . _ea_ker , sqrtQ = imgr_so . _sqrtQ , Linearized_Approximation = True , DisplayImage = True ) eh . comp_plots . plotall_obs_im_compare ( obs , imgr_so . out_last ( ) , <str> , <str> ) eh . comp_plots . plotall_obs_im_compare ( obs , imgr_so . out_scattered_last ( ) , <str> , <str> ) imgr_so . alpha_phi_next /= 2.0 imgr_so . init_next = imgr_so . out_last ( ) . blur_circ ( obs . res ( ) ) imgr_so . epsilon_list_next = imgr_so . out_epsilon_last ( ) imgr_so . make_image_I_stochastic_optics ( ) imgr_so . out_last ( ) . display ( )  